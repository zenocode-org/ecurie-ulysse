---
import cavasoftImage from "../../images/commun/cavasoft_light.png";

export interface Props {
  href?: string;
  tooltipText?: string;
}

const { href = "#", tooltipText = "L'espace dédié aux cavaliers" } = Astro.props;
---

<a
  href={href}
  id="cavasoft-button"
  data-tooltip={tooltipText}
  data-position="left"
  class="fixed bottom-6 right-6 z-50 rounded-full shadow-lg hover:shadow-xl transition-shadow duration-300 opacity-0 cavasoft-button-wrapper"
  aria-label="Cavasoft"
>
  <img
    src={cavasoftImage.src}
    alt="Cavasoft"
    class="w-16 h-16 rounded-full object-cover"
  />
</a>

<style>
  /* Force tooltip to show when show-tooltip class is present */
  .cavasoft-button-wrapper.show-tooltip::after,
  .cavasoft-button-wrapper.show-tooltip:hover::after {
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
  }
</style>

<script>
  (function() {
    const button = document.getElementById("cavasoft-button") as HTMLAnchorElement;
    if (!button) return;

    const STORAGE_KEY = "cavasoft-tooltip-shown";
    const hasShownTooltip = localStorage.getItem(STORAGE_KEY) === "true";

    // Show button immediately
    button.classList.remove("opacity-0");
    button.classList.add("opacity-100");

    // If tooltip was already shown, don't show it again
    if (hasShownTooltip) {
      return;
    }

    let scrollHandler: (() => void) | null = null;
    let timeoutId: ReturnType<typeof setTimeout> | null = null;
    let hasScrolled = false;

    function showTooltip() {
      if (hasScrolled) return;
      hasScrolled = true;

      // Add class to force tooltip display
      button.classList.add("show-tooltip");

      // Mark as shown in localStorage
      localStorage.setItem(STORAGE_KEY, "true");

      // Hide after 5 seconds
      timeoutId = setTimeout(() => {
        button.classList.remove("show-tooltip");
      }, 5000);
    }

    scrollHandler = function() {
      // Show tooltip on first scroll
      showTooltip();
    };

    // Add scroll listener (once: true will auto-remove after first scroll)
    window.addEventListener("scroll", scrollHandler, { once: true, passive: true });

    // Cleanup on page unload
    window.addEventListener("beforeunload", () => {
      if (scrollHandler) {
        window.removeEventListener("scroll", scrollHandler);
      }
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
    });
  })();
</script>

